# Support QA Bot

## Общие данные

Бот написан с помощью библиотеки [grammy](https://grammy.dev/)

## Конфигурация и пользователи

Токен бота и адрес БД указываются в файле конфигурации `/config/default.json`.

Аккаунты поддержки прописываются в массив `SUPPORT_USERS` в `/src/constants/users.ts`.

В `ADMIN_CHAT_ID` указывается *ID* личного чата администратора с ботом, куда будут приходить ошибки бота. Если оставить в качестве значения `null`, то ошибки будут логироваться в консоль. 

## Сессии

Сессии позволяют хранить информацию и состояния о групповых чатах (уникально для каждого чата) и обращаться к ним при каждом новом сообщении в чате. Сессия хранится в json файле, который генерируется автоматически. Название файла - **id** чата. 

Сессии необходимо где-то хранить. По умолчанию сессии хранятся локально через [встроенный адаптер](https://grammy.dev/plugins/session.html#known-storage-adapters). Хранить сессии можно, по сути, где угодно. Существующие адаптеры можно найти [здесь](https://github.com/grammyjs/storages/tree/main/packages#grammy-storages). Если подходящего адаптера нет, то можно написать свой. Он должен соответствовать [этому интерфейсу](https://deno.land/x/grammy@v1.16.0/mod.ts?s=StorageAdapter)

## Хранение данных

По умолчанию данные записываются в локальную [SQLite](https://sqlite.org/index.html) БД с помощью библиотеки [Sequelize](https://sequelize.org/).

Схема таблицы прописана в `/src/modules/db-control/db-model`. По необходимости **SQLite** можно заменить на любую другую БД, совместимую с **Sequelize** или воспользоваться другим решением записи и хранения данных.

## Алгоритм работы

- Бот видит входящее сообщение в групповом чате
- Все сообщения по умолчанию сохраняются в БД. Подробнее в разделе [Хранение данных](#хранение-данных)
- Бот определяет это сообщение от клиента или от аккаунта поддержки.
- Если это сообщение от клиента, и ранее незакрытых обращений от клиента не было, бот меняет `state` сессии на `open`
- Если это очередное сообщение клиента, а `state` все еще `open`, ничего не происходит (кроме сохранения сообщения в БД)
- Если это сообщение от поддержки и `state` сейчас `open`, это считается ответом на запрос клиента. `state` переходит в `closed`. Также в БД сохраняется время (в минутах), которое прошло между первым неотвеченным сообщением клиента (сообщение, которое перевело `state` в `open`) и между ответом поддержки.
- Если это сообщение от поддержки и `state` сейчас `closed`, ничего не происходит (кроме сохранения сообщения в БД)
- Поддержка может вручную помнять `state` на `closed` с помощью команды `/closeticket`. 

## Сборка и запуск

На машине должен быть установлен **NodeJS**.

- Скачиваем репозиторий
- Устанавливаем зависимости ```$ npm i```
- Собираем проект ```$ npm run build```
- Заходим в папку dist ```$ cd dist```
- Запускаем бота ```$ node main.cjs```
